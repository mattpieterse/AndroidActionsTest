name: Enforce Commit Message Format

on:
  push:

jobs:
  check-commit-messages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required to access full commit history

      - name: Get pushed commit messages
        id: commits
        run: |
          echo "Checking commits between ${{ github.event.before }} and ${{ github.sha }}..."
          git log --pretty=format:'%h %s' ${{ github.event.before }}..${{ github.sha }} > commits.txt
          cat commits.txt

      - name: Validate commit messages
        run: |
          VALID=true

          while read -r line; do
            COMMIT_HASH=$(echo "$line" | cut -d' ' -f1)
            COMMIT_MSG=$(echo "$line" | cut -d' ' -f2-)

            echo "→ Checking: $COMMIT_MSG"

            if [[ ! "$COMMIT_MSG" =~ ^(feat|fix|docs|style|refactor|test|chore|ci|build|perf|revert)(\([a-z0-9-]+\))?(!)?:\ .+ ]]; then
              echo "::error file=commit.txt,line=1::❌ Invalid commit message: \"$COMMIT_MSG\""
              VALID=false
            fi
          done < commits.txt

          if [[ "$VALID" == "false" ]]; then
            echo "One or more commit messages are invalid."
            exit 1
          else
            echo "✅ All commit messages are valid."
          fi
