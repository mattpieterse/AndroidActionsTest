name: Enforce Commit Message Format

on:
  push:  # Apply to all branches

jobs:
  check-commit-messages:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commit messages
        run: |
          echo "ðŸ” Checking commits between ${{ github.event.before }} and ${{ github.sha }}..."

          # Get commit messages in range
          git log --format='%H|%s' ${{ github.event.before }}..${{ github.sha }} > commits.txt

          # Define regex for conventional commits with optional scope and !
          REGEX='^(feat|fix|docs|style|refactor|test|chore|ci|build|perf|revert)(\([a-z0-9-]+\))?(!)?: .+'

          echo "ðŸ“‹ Commit messages:"
          echo "--------------------------------------"

          VALID=true

          while IFS= read -r line; do
            COMMIT_HASH="${line%%|*}"
            COMMIT_MSG="${line#*|}"
            COMMIT_MSG="$(echo "$COMMIT_MSG" | xargs)"  # trim spaces

            echo "â†’ $COMMIT_MSG"

            if ! [[ "$COMMIT_MSG" =~ $REGEX ]]; then
              echo "::error file=commit.txt,line=1::Invalid commit: \"$COMMIT_MSG\""
              VALID=false
            fi
          done < commits.txt

          echo "--------------------------------------"

          if [ "$VALID" = false ]; then
            echo "âŒ Some commit messages are invalid."
            exit 1
          else
            echo "âœ… All commit messages passed."
          fi
